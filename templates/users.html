<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Usuarios HRM</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #111735;
      --text: #e7eaf3;
      --muted: #9aa3b2;
      --border: #2a3355;
      --accent: #eab308;
      --danger: #ef4444;
      --sim-row: rgba(234, 179, 8, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      background: var(--bg); color: var(--text);
    }
    .wrap { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 16px; font-size: 28px; }

    .toolbar {
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 14px;
    }
    .btn {
      appearance: none; border: 1px solid var(--border);
      background: var(--card); color: var(--text);
      border-radius: 10px; padding: 8px 12px; font-weight: 700; cursor: pointer;
      text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn:hover { border-color: var(--accent); }
    .btn-accent { background: var(--accent); color: #111; border-color: var(--accent); }
    .btn-accent:hover { filter: brightness(1.05); }

    .filters {
      display: inline-flex; gap: 0; border: 1px solid var(--border); border-radius: 10px; overflow: hidden;
    }
    .filters button {
      border: none; background: transparent; color: var(--text);
      padding: 8px 12px; font-weight: 800; cursor: pointer;
    }
    .filters button + button { border-left: 1px solid var(--border); }
    .filters button.active { background: var(--accent); color: #111; }

    table {
      width: 100%; border-collapse: collapse; overflow: hidden;
      border: 1px solid var(--border); border-radius: 12px; background: var(--card);
    }
    th, td {
      padding: 10px 12px; text-align: center; border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    thead th { background: #0e1630; font-weight: 800; }
    tbody tr:last-child td { border-bottom: none; }
    tr.sim { background: var(--sim-row); }
    .muted { color: var(--muted); }

    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 800;
      background: #312a00; color: var(--accent); border: 1px solid #5b4a00; margin-left: 8px;
    }
    .badge .dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--accent);
      box-shadow: 0 0 8px rgba(234, 179, 8, 0.6);
    }

    .actions a {
      color: #0b1020; background: var(--accent); border-radius: 8px; padding: 6px 10px;
      text-decoration: none; font-weight: 800; display: inline-block; margin: 2px 4px;
    }
    .actions a:hover { filter: brightness(1.05); }
    .actions a.delete { background: var(--danger); color: #fff; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üë§ Usuarios HRM</h1>

    <div class="toolbar">
      <a class="btn btn-accent" href="{{ url_for('add_user') }}">‚ûï A√±adir usuario</a>

      <div class="filters" role="group" aria-label="Filtro de tipo de usuario">
        <button type="button" class="active" data-filter="all" id="btn-all">Todos (0)</button>
        <button type="button" data-filter="real" id="btn-real">Reales (0)</button>
        <button type="button" data-filter="sim" id="btn-sim">Simulados (0)</button>
      </div>

      <button class="btn" id="btn-refresh" title="Invalidar cach√©s /live y m√©tricas">
        ‚Üª Actualizar recuadros
      </button>
    </div>

    <table id="tab">
      <thead>
        <tr>
          <th>ID</th>
          <th>Apodo</th>
          <th>Edad</th>
          <th>Peso</th>
          <th>Sexo</th>
          <th>Device ID</th>
          <th>FC Reposo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr class="{{ 'sim' if u.is_sim else '' }}" data-is-sim="{{ 1 if u.is_sim else 0 }}">
          <td>{{ u.id }}</td>
          <td>
            {{ u.nombre }} {{ u.apellido }}
            {% if u.is_sim %}
              <span class="badge" title="Usuario simulado">
                <span class="dot"></span> Simulado
              </span>
            {% endif %}
          </td>
          <td class="{{ 'muted' if not u.edad }}">{{ u.edad or '‚Äî' }}</td>
          <td class="{{ 'muted' if not u.peso }}">{{ u.peso or '‚Äî' }}</td>
          <td class="{{ 'muted' if not u.sexo }}">{{ u.sexo or '‚Äî' }}</td>
          <td class="{{ 'muted' if not u.device_id }}">{{ u.device_id or '‚Äî' }}</td>
          <td class="{{ 'muted' if not u.hr_rest }}">{{ u.hr_rest or '‚Äî' }}</td>
          <td class="actions">
            <a href="{{ url_for('edit_user', user_id=u.id) }}">‚úèÔ∏è Editar</a>
            <a class="delete" href="{{ url_for('delete_user', user_id=u.id) }}"
               onclick="return confirm('¬øBorrar usuario &quot;{{ u.apodo }}&quot;?')">üóëÔ∏è Borrar</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    (function() {
      const rows = Array.from(document.querySelectorAll('tbody tr'));
      const btns = Array.from(document.querySelectorAll('.filters button'));
      const btnAll  = document.getElementById('btn-all');
      const btnReal = document.getElementById('btn-real');
      const btnSim  = document.getElementById('btn-sim');
      const btnRefresh = document.getElementById('btn-refresh');

      function counts() {
        const total = rows.length;
        const sim = rows.filter(r => r.dataset.isSim === "1").length;
        const real = total - sim;
        return { total, real, sim };
      }

      function paintCounts() {
        const { total, real, sim } = counts();
        btnAll.textContent  = `Todos (${total})`;
        btnReal.textContent = `Reales (${real})`;
        btnSim.textContent  = `Simulados (${sim})`;
      }

      function setFilter(mode) {
        rows.forEach(tr => {
          const isSim = tr.dataset.isSim === "1";
          let show = true;
          if (mode === 'real') show = !isSim;
          else if (mode === 'sim') show = isSim;
          tr.style.display = show ? '' : 'none';
        });
        btns.forEach(b => b.classList.toggle('active', b.dataset.filter === mode));
      }

      btns.forEach(b => b.addEventListener('click', () => setFilter(b.dataset.filter)));

      btnRefresh.addEventListener('click', async () => {
        btnRefresh.disabled = true;                       // ‚Üê min√∫scula
        btnRefresh.textContent = 'Actualizando‚Ä¶';
        try {
          await fetch('/admin/refresh', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ reset_sessions: false }) // mantener kcal/puntos
          });
          btnRefresh.textContent = '¬°Listo!';
          setTimeout(() => {
            btnRefresh.textContent = '‚Üª Actualizar recuadros';
            btnRefresh.disabled = false;                  // ‚Üê min√∫scula
          }, 900);
        } catch(e) {
          btnRefresh.textContent = 'Error';
          setTimeout(() => {
            btnRefresh.textContent = '‚Üª Actualizar recuadros';
            btnRefresh.disabled = false;                  // ‚Üê min√∫scula
          }, 1200);
        }
      });


      // inicializar
      paintCounts();
      setFilter('all');
    })();
  </script>
</body>
</html>
