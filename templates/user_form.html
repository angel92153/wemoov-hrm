<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{{ 'Editar usuario' if user else 'Añadir usuario' }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/brand.css">
  <style>
    .switch { display:flex; align-items:center; gap:10px; }
    .switch input[type="checkbox"]{ width:18px; height:18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>{{ 'Editar usuario' if user else 'Añadir usuario' }}</h1>

    <div class="panel card-pad">
      <form method="post" action="" class="grid">
        <div>
          <label>Nombre</label>
          <input name="nombre" value="{{ user.nombre if user else '' }}" required>
        </div>
        <div>
          <label>Apellido</label>
          <input name="apellido" value="{{ user.apellido if user else '' }}" required>
        </div>

        <div>
          <label>Apodo</label>
          <input name="apodo" value="{{ user.apodo if user else '' }}" placeholder="Se muestra en las tarjetas">
        </div>
        <div>
          <label>Sexo</label>
          <select name="sexo">
            {% set s = (user.sexo if user else 'M') or 'M' %}
            <option value="M" {{ 'selected' if s=='M' else '' }}>M</option>
            <option value="F" {{ 'selected' if s=='F' else '' }}>F</option>
          </select>
        </div>

        <div>
          <label>Fecha de nacimiento</label>
          <input type="date" name="dob" value="{{ user.dob if user and user.dob else '' }}" required>
          {% if user and user.dob %}
            <div class="form-help">Edad detectada: {{ user.dob|age_from_dob or '—' }}</div>
          {% endif %}
        </div>
        <div></div>

        <div>
          <label>Peso (kg)</label>
          <input type="number" step="0.1" name="peso" min="1" max="500" value="{{ user.peso if user and user.peso else '' }}">
        </div>
        <div></div>

        <!-- Dispositivo real -->
        <div class="full">
          <label>Device ID</label>
          <div class="form-row">
            <input id="device_id" name="device_id" type="number" placeholder="Ej: 36466"
                  value="{{ user.device_id if user and user.device_id else '' }}">
            <button type="button" id="btnReload" class="btn">Recargar libres</button>
          </div>
          <div class="form-row" style="margin-top:8px;">
            <select id="selFree">
              <option value="">— Pulsómetros libres detectados —</option>
            </select>
          </div>
          <div class="form-help">Escribe un ID manualmente o elige uno detectado sin usuario (últimos 45s).</div>
        </div>

        <!-- DEMO (solo sesión; no se guarda en DB) -->
        <div class="full">
          <label>Asignar DEMO (solo esta sesión)</label>
          <div class="form-row">
            <select id="selDemo" name="demo_dev">
              <option value="">— Sin DEMO —</option>
              {% for label, dev in demo_slots or [] %}
                <option value="{{ dev }}" {{ 'selected' if demo_for_user==dev else '' }}>
                  {{ label }} · ID {{ dev }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-help">
            Los DEMO no se guardan en la base de datos. Si reasignas un DEMO a otro usuario, se libera del anterior automáticamente.
          </div>
        </div>

        <script>
          // Si eligen un DEMO, no imponemos nada en device_id (pueden convivir),
          // pero si prefieres, puedes limpiar el device_id al elegir DEMO:
          const selDemo = document.getElementById('selDemo');
          selDemo && selDemo.addEventListener('change', () => {
          });
        </script>


        <div>
          <label>FC Reposo (opcional)</label>
          <input type="number" name="hr_rest" min="30" max="120" value="{{ user.hr_rest if user and user.hr_rest else '' }}">
        </div>

        <!-- FC Máx + modo auto/manual -->
        {% set auto = (user.hr_max_auto == 1) if user else true %}
        {% set hrmax_disp = (user.hr_max if user and user.hr_max else ((user.dob|tanaka_dob) or (user.edad|tanaka))) %}
        <div>
          <label>FC Máx</label>
          <div class="switch">
            <input type="checkbox" id="hrmax_auto" name="hr_max_auto" {{ 'checked' if auto else '' }}>
            <label for="hrmax_auto" class="muted">Calcular automáticamente (Tanaka)</label>
          </div>
          <input type="number" id="hr_max" name="hr_max" min="120" max="230"
                 value="{{ ('' if auto else (hrmax_disp or '')) }}"
                 placeholder="{{ auto and hrmax_disp or '' }}"
                 {{ 'disabled' if auto else '' }}>
          {% if auto %}
            <div class="form-help">Mostrando estimación: {{ hrmax_disp or '—' }} (se recalcula con la edad).</div>
          {% else %}
            <div class="form-help">Valor manual (bloqueado). No se ajusta con la edad.</div>
          {% endif %}
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-accent">{{ 'Guardar cambios' if user else 'Crear usuario' }}</button>
          <a href="{{ url_for('users_list') }}" class="btn">Volver</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Pulsómetros libres
    const selFree = document.getElementById('selFree');
    const inputDev = document.getElementById('device_id');
    const btnReload = document.getElementById('btnReload');

    async function loadFree(recent=45){
      try{
        btnReload.disabled = true; btnReload.textContent = 'Cargando…';
        const res = await fetch(`/api/unassigned_devices?recent=${recent}`, { cache:'no-store' });
        const data = await res.json();
        const list = (data && data.devices) ? data.devices : [];
        selFree.innerHTML = '<option value="">— Pulsómetros libres detectados —</option>';
        if (!list.length){
          const opt = document.createElement('option');
          opt.value = ''; opt.textContent = 'No hay pulsómetros libres ahora mismo';
          selFree.appendChild(opt);
        }else{
          list.forEach(d=>{
            const opt = document.createElement('option');
            const label = d.ts ? `${d.dev} · HR ${d.hr ?? '--'} · ${d.ts}` : `${d.dev} · HR ${d.hr ?? '--'}`;
            opt.value = d.dev; opt.textContent = label; selFree.appendChild(opt);
          });
        }
      }catch(e){
        selFree.innerHTML = '<option value="">(Error cargando lista)</option>';
      }finally{
        btnReload.textContent = 'Recargar libres'; btnReload.disabled = false;
      }
    }

    selFree.addEventListener('change', () => { if (selFree.value) inputDev.value = selFree.value; });
    btnReload.addEventListener('click', () => loadFree(45));
    loadFree(45);

    // Toggle auto/manual FC Máx
    const chkAuto = document.getElementById('hrmax_auto');
    const inpHrMx = document.getElementById('hr_max');
    chkAuto.addEventListener('change', () => {
      const on = chkAuto.checked;
      inpHrMx.disabled = on;
      if (on) { inpHrMx.value = ''; }
    });
  </script>
</body>
</html>
