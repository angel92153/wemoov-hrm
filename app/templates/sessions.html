<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Clases & Calendario</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/static/brand.css">
  <style>
    .wrap-narrow{ max-width: 900px; margin: 0 auto; }
    .panel{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow-lg); }
    .pad{ padding:16px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .stack{ display:grid; gap:16px; }
    .calendar{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width: 920px){ .calendar{ grid-template-columns: repeat(7, 1fr); } }
    .day h4{ margin:0 0 8px; font-family:var(--ff-head); }
    .badge{ display:inline-flex; gap:6px; padding:2px 8px; border-radius:999px; background:#1c1433; border:1px solid #2a1e4d; color:var(--accent); font-weight:800; font-size:12px }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:8px; border-bottom:1px solid var(--border); text-align:center; }
    thead th{ background:linear-gradient(180deg, #171717, #121212); font-family:var(--ff-head); }
    .muted{ color:var(--muted); }
    .btn-icon{
      appearance:none; border:none; background:transparent; color:var(--muted); cursor:pointer;
      font-size:16px; padding:4px; border-radius:8px; line-height:1;
    }
    .btn-icon:hover{ color:#fff; background:#181818; }
    .right{ margin-left:auto; }
    .time-row{ position:relative; width:100%; display:flex; align-items:center; }
    .time-input{ flex:1; padding-right:28px; min-width:0; }
    .trash-in-input{ position:absolute; right:4px; top:50%; transform:translateY(-50%); font-size:14px; opacity:0.85; }
    input[type="time"]::-webkit-calendar-picker-indicator{ display:none; }
    input[type="time"]{ -moz-appearance: textfield; appearance: textfield; }
  </style>
</head>
<body>
<div class="wrap-narrow">
  <h1>Clases & Calendario</h1>

  <div class="stack">

    <!-- Editor de clases -->
    <section class="panel pad">
      <h2 style="margin:0 0 8px">Editor de clases</h2>

      <div class="row">
        <label>Clases guardadas:</label>
        <select id="editorSelector"></select>
        <button class="btn" id="newClassBtn">Crear nueva clase</button>
      </div>

      <div class="row" style="margin-top:8px">
        <input id="editLabel" placeholder="Nombre de la clase (p.ej. Moov Class)" style="flex:1">
        <input id="editId" type="hidden">
        <button class="btn" id="saveClass">Guardar</button>
        <button class="btn btn-danger" id="deleteClass">Eliminar</button>
      </div>

      <table style="margin-top:8px">
        <thead><tr><th>#</th><th>Fase</th><th>Duraci√≥n (s)</th><th>Color</th><th></th></tr></thead>
        <tbody id="phBody"></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn" id="addPhase">+ A√±adir fase</button></div>
    </section>

    <!-- Calendario + default + one-off -->
    <section class="panel pad">
      <h2 style="margin:0 0 8px">Calendario semanal</h2>

      <div class="row">
        <label>Clase por defecto:</label>
        <select id="defaultClass"></select>
        <button class="btn" id="saveDefault">Guardar por defecto</button>
        <span id="defInfo" class="badge" style="margin-left:8px"></span>
        <button class="btn btn-accent right" id="saveCalendar">Guardar cambios</button>
      </div>

      <div class="calendar" id="calendar" style="margin-top:10px"></div>

      <h3 style="margin:14px 0 6px">Programaci√≥n puntual por d√≠a</h3>
      <div class="row">
        <input type="date" id="ooDate">
        <select id="ooClass"></select>
        <button class="btn" id="ooAdd">A√±adir / Reemplazar</button>
      </div>
      <div id="ooList" style="margin-top:8px"></div>
    </section>
  </div>
</div>

<script>
const $ = id => document.getElementById(id)
const API = '/sessions'  // <‚Äî base para todas las rutas del backend
const COLORS = [
  {name:'Warm up', val:'#16a34a'},
  {name:'Demo/Trans', val:'#6b21a8'},
  {name:'Bloque', val:'#eab308'},
  {name:'Cooldown', val:'#1d4ed8'}
]
const DAYS = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom']
let classes = []
let phasesBuffer = []
let calItems = []

// ============ CLASES ============
async function fetchClasses(){
  const res = await fetch(`${API}/classes`); const j = await res.json(); classes = j.classes||[]
  const ed = $('editorSelector'); ed.innerHTML=''
  classes.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.textContent=c.label; ed.appendChild(o) })
  const def = $('defaultClass'); def.innerHTML = classes.map(c=>`<option value="${c.id}">${c.label}</option>`).join('')
  const oo = $('ooClass'); oo.innerHTML = def.innerHTML
  if(classes.length){ loadEditor(classes[0]) }
}

function loadEditor(c){
  $('editorSelector').value = c.id
  $('editId').value = c.id
  $('editLabel').value = c.label
  phasesBuffer = c.phases.map(p=>({key:p.key, dur_s:p.dur_s, color:p.color}))
  renderPhases()
  enforceMoovLock()
}

function enforceMoovLock(){
  const isMoov = ($('editId').value === 'moov' || $('editLabel').value.trim().toLowerCase() === 'moov class')
  $('editLabel').readOnly = isMoov
  $('deleteClass').style.display = isMoov ? 'none' : ''
  $('addPhase').disabled = isMoov
  document.querySelectorAll('#phBody input, #phBody select, #phBody button').forEach(el=>{
    if (el.getAttribute('data-del') !== null){ el.style.display = isMoov ? 'none' : '' }
    if (el.tagName === 'BUTTON') return
    el.disabled = isMoov
  })
}

$('editorSelector').onchange = (e)=>{
  const c = classes.find(x=>x.id===e.target.value); if(c) loadEditor(c)
}
$('newClassBtn').onclick = ()=>{
  $('editId').value = ''
  $('editLabel').value = ''
  phasesBuffer = []
  renderPhases()
  enforceMoovLock()
}

function renderPhases(){
  const tb = $('phBody'); tb.innerHTML=''
  phasesBuffer.forEach((p,i)=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input data-i="${i}" data-k="key" value="${p.key}"></td>
      <td><input type="number" data-i="${i}" data-k="dur_s" value="${p.dur_s}"></td>
      <td>
        <select data-i="${i}" data-k="color">
          ${COLORS.map(c=>`<option value="${c.val}" ${c.val===p.color?'selected':''}>${c.name}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn btn-ghost" data-del="${i}">üóëÔ∏è</button></td>`
    tb.appendChild(tr)
  })
}

$('phBody').addEventListener('input', e=>{
  const i = e.target.getAttribute('data-i'); const k = e.target.getAttribute('data-k')
  if(i!==null && k){ let v=e.target.value; if(k==='dur_s') v=parseInt(v||'0',10); phasesBuffer[i][k]=v }
})
$('phBody').addEventListener('click', e=>{
  const del=e.target.getAttribute('data-del'); if(del!=null){ phasesBuffer.splice(parseInt(del,10),1); renderPhases(); enforceMoovLock() }
})
$('addPhase').onclick = ()=>{ phasesBuffer.push({key:'NEW', dur_s:60, color:COLORS[2].val}); renderPhases(); enforceMoovLock() }
$('saveClass').onclick = async ()=>{
  // Sanea y genera id si est√° vac√≠o
  let id = $('editId').value.trim()
  const label = ($('editLabel').value.trim() || 'Nueva clase')
  if(id === 'moov' || label.toLowerCase() === 'moov class'){
    alert('‚ÄúMoov Class‚Äù no se puede editar.')
    return
  }
  if(!id){ id = label.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'') }
  const body = { id, label, phases: phasesBuffer }
  const resp = await fetch(`${API}/classes`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
  })
  const j = await resp.json()
  if(!j.ok){ alert('Error al guardar: ' + (j.error||'')); return }
  await fetchClasses()
}
$('deleteClass').onclick = async ()=>{
  const id = $('editId').value.trim(); if(!id || id==='moov') return
  if(!confirm('¬øEliminar clase '+id+'?')) return
  const r = await fetch(`${API}/classes/`+encodeURIComponent(id), {method:'DELETE'})
  const j = await r.json()
  if(!j.ok){ alert('Error al eliminar: ' + (j.error||'')); return }
  await fetchClasses()
}

// ---- Default class ----
async function loadDefault(){
  const r = await fetch(`${API}/default_class`); const j = await r.json(); const id=j.default_class_id
  $('defaultClass').value = id
  const found = classes.find(c => c.id === id);
  const name  = found ? found.label : id;
  $('defInfo').textContent = 'Default: ' + name
}
$('saveDefault').onclick = async ()=>{
  const id = $('defaultClass').value
  const resp = await fetch(`${API}/default_class`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({class_id:id})})
  await resp.json()
  const found = classes.find(c => c.id === id);
  $('defInfo').textContent = 'Default: ' + (found ? found.label : id)
}

// ============ CALENDARIO (edici√≥n local + guardar masivo) ============
async function loadCalendar(){
  const res = await fetch(`${API}/calendar`); const j = await res.json();
  calItems = (j.items||[]).map(x=>({sched_id:x.sched_id, dow:x.dow, time_str:x.time_str}))
  renderCalendar()
}

function renderCalendar(){
  const wrap = $('calendar'); wrap.innerHTML=''
  for(let d=0; d<7; d++){
    const col = document.createElement('div'); col.className='day panel'
    const inner = document.createElement('div'); inner.className='pad'
    const h = document.createElement('h4'); h.textContent = DAYS[d]
    inner.appendChild(h)

    const idxs = calItems
      .map((it,idx)=>({it,idx}))
      .filter(x=>x.it.dow===d)
      .sort((a,b)=>a.it.time_str.localeCompare(b.it.time_str))
      .map(x=>x.idx)

    idxs.forEach(ci=>{
      const it = calItems[ci]
      const row = document.createElement('div'); row.className='time-row'
      row.innerHTML = `
        <input class="time-input" type="time" value="${it.time_str}" data-ci="${ci}">
        <button class="btn-icon trash-in-input" title="Eliminar" data-del-ci="${ci}">üóëÔ∏è</button>`
      inner.appendChild(row)
    })

    const add = document.createElement('div'); add.className='row';
    add.innerHTML = `<input class="time-input" type='time' value='08:00' data-add-time data-dow='${d}'> <button class='btn' data-add='${d}'>A√±adir</button>`
    inner.appendChild(add)

    col.appendChild(inner); wrap.appendChild(col)
  }
}

$('calendar').addEventListener('input', (e)=>{
  const ci = e.target.getAttribute('data-ci')
  if(ci!=null){
    calItems[parseInt(ci,10)].time_str = e.target.value
  }
})
$('calendar').addEventListener('click', (e)=>{
  const add = e.target.getAttribute('data-add')
  const delCi = e.target.getAttribute('data-del-ci')
  if (add!=null){
    const box = e.target.parentElement
    const time = box.querySelector('input[data-add-time]').value
    calItems.push({dow:parseInt(add,10), time_str:time})
    renderCalendar()
  }
  if (delCi!=null){
    calItems.splice(parseInt(delCi,10), 1)
    renderCalendar()
  }
})

$('saveCalendar').onclick = async ()=>{
  const payload = { items: calItems.map(x=>({dow:x.dow, time_str:x.time_str})) }
  const resp = await fetch(`${API}/calendar_bulk`, {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  })
  const j = await resp.json()
  if(!j.ok){ alert('Error al guardar calendario: ' + (j.error||'')); return }
  await loadCalendar()
}

// ============ ONE-OFF (d√≠a) ============
async function loadOneOff(){
  const r = await fetch(`${API}/oneoff`); const j = await r.json(); const items=j.items||[]
  const box = $('ooList'); box.innerHTML=''
  items.forEach(it=>{
    const row = document.createElement('div'); row.className='row'
    row.innerHTML = `<span class='badge'>${it.ymd}</span> <span>${it.class_id}</span> <button class='btn btn-ghost' data-oodel='${it.ymd}'>Eliminar</button>`
    box.appendChild(row)
  })
}
$('ooAdd').onclick = async ()=>{
  const ymd = $('ooDate').value; const cid = $('ooClass').value
  if(!ymd){ alert('Selecciona fecha'); return }
  await fetch(`${API}/oneoff`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ymd:ymd, class_id:cid})})
  loadOneOff()
}
$('ooList').addEventListener('click', async (e)=>{
  const del = e.target.getAttribute('data-oodel'); if(del){ await fetch(`${API}/oneoff/`+del, {method:'DELETE'}); loadOneOff() }
})

// Init
fetchClasses().then(()=>{ loadCalendar(); loadDefault(); loadOneOff() })
</script>
</body>
</html>
