<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Control de sesión</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/static/brand.css">
  <style>
    .wrap-narrow{ max-width: 760px; margin: 0 auto; }
    .center{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; min-height:70vh; text-align:center; }

    .timer{
      font-family: var(--ff-head);
      font-weight: 800;
      font-size: clamp(32px, 9vw, 86px);
      letter-spacing: .5px;
    }
    .timer.phase { color: var(--text); }
    .timer.countdown { color: #ffffff; }

    .phase-label{
      font-size: clamp(18px, 3vw, 36px);
      color: var(--muted);
      font-family: var(--ff-head);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .controls{ display:flex; gap:18px; align-items:center; justify-content:center; }

    .ctrl{
      appearance:none; border:1px solid var(--border); background:var(--card); color:var(--text); cursor:pointer;
      width:72px; height:72px; border-radius:50%;
      display:flex; align-items:center; justify-content:center; font-size:34px;
      box-shadow: var(--shadow-lg);
      transition: transform .06s ease, border-color .2s;
    }
    .ctrl:hover{ border-color: var(--accent); }
    .ctrl:active{ transform: translateY(1px); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; }

    .panel-inner{ padding:16px; display:grid; grid-template-columns:1fr; gap:10px; }
    .form-row{ display:grid; grid-template-columns:1fr auto auto; gap:8px; }

    select{ padding:10px 12px; border-radius:12px; }

    .status{ font-size:13px; color:var(--muted); text-align:center; min-height:1.4em; }
  </style>
</head>
<body>
<div class="wrap-narrow">

  <div class="panel" style="margin: 12px auto 22px;">
    <div class="panel-inner">
      <div class="form-row">
        <select id="classSelect" aria-label="Selecciona una clase">
          <option value="">— Cargando clases… —</option>
        </select>
        <button id="startClass" class="btn btn-accent">Iniciar</button>
        <button id="stopClass" class="btn btn-danger">Detener</button>
      </div>
      <div id="classStatus" class="status"></div>
    </div>
  </div>

  <div class="center">
    <div id="info" class="phase-label"></div>
    <div id="timer" class="timer">--:--</div>
    <div id="controls" class="controls" style="display:none;">
      <button class="ctrl" id="prev" title="Atrás">⏮</button>
      <button class="ctrl" id="toggle" title="Pausa / Play">⏯</button>
      <button class="ctrl" id="next" title="Adelante">⏭</button>
    </div>
    <div id="hint" class="row"></div>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);

function fmt(s){
  s = Math.max(0, s|0);
  const m = Math.floor(s/60), ss = s%60;
  return String(m).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
}

/* ==================== CARGA DE CLASES ==================== */
async function loadClasses(){
  const sel = $('classSelect');
  const status = $('classStatus');
  try{
    status.textContent = 'Cargando clases…';
    const r = await fetch('/control/classes', { cache:'no-store' });
    const raw = await r.json();
    const list = Array.isArray(raw) ? raw : (Array.isArray(raw.classes) ? raw.classes : []);

    const rows = (Array.isArray(list) ? list : []).map(c => {
      const id = c.id ?? c.key ?? c.class_id ?? c.slug ?? c.name ?? c.label;
      const label = c.label ?? c.name ?? c.title ?? String(id);
      return id ? { id: String(id), label: String(label) } : null;
    }).filter(Boolean);

    sel.innerHTML = '';
    if (!rows.length){
      sel.innerHTML = '<option value="">— No hay clases disponibles —</option>';
      status.textContent = 'No hay clases en el catálogo.';
      return;
    }

    const frag = document.createDocumentFragment();
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = '— Selecciona una clase —';
    frag.appendChild(opt0);

    rows.forEach(({id,label}) => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = label;
      frag.appendChild(opt);
    });
    sel.appendChild(frag);
    status.textContent = '';
  }catch(e){
    sel.innerHTML = '<option value="">(Error cargando clases)</option>';
    status.textContent = 'No se pudieron cargar las clases.';
  }
}

/* ==================== BOTONES ==================== */
$('startClass').onclick = async () => {
  const sel = $('classSelect');
  const cid = sel.value;
  const status = $('classStatus');
  if (!cid){
    status.textContent = 'Selecciona una clase antes de iniciar.';
    return;
  }
  try{
    $('startClass').disabled = true;
    status.textContent = 'Iniciando clase…';
    const r = await fetch('/control/start', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ class_id: cid })
    });
    const j = await r.json();
    if (j && j.ok){
      status.textContent = 'Clase iniciada.';
      await poll();
    }else{
      status.textContent = 'No se pudo iniciar la clase.';
    }
  }catch(e){
    status.textContent = 'Error iniciando la clase.';
  }finally{
    $('startClass').disabled = false;
  }
};

$('stopClass').onclick = async () => {
  const status = $('classStatus');
  try{
    const r = await fetch('/control/stop', { method:'POST' });
    if (r.ok){
      status.textContent = 'Sesión detenida.';
      await poll();
    }else{
      status.textContent = 'No se pudo detener la sesión.';
    }
  }catch(e){
    status.textContent = 'Error deteniendo la sesión.';
  }
};

/* ==================== POLL DE ESTADO ==================== */
async function poll(){
  try{
    const r = await fetch('/control/status', { cache:'no-store' });
    const j = await r.json();
    const t = $('timer'), info = $('info'), controls = $('controls'), hint = $('hint');

    // ===== COUNTDOWN (manual o semanal) =====
    if(!j.active && j.show_countdown){
      const planned = j.next_class_id || j.class_id || 'moov';

      t.className = 'timer countdown';
      t.style.color = '#ffffff';
      info.style.color = '#ffffff';
      t.textContent = fmt(j.countdown_s ?? 0);

      // Muestra “· PAUSA” si está congelado el countdown manual
      const pausedSuffix = (j.countdown_paused ? ' · PAUSA' : '');
      info.textContent = 'COUNTDOWN' + pausedSuffix;

      controls.style.display = '';
      hint.innerHTML = planned ? `<span class="pill">Clase: ${planned}</span>` : '';

      // ⏭ → empezar ya
      $('next').onclick = async ()=>{
        await fetch('/control/start', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ class_id: planned })
        });
        await poll();
      };

      // ⏯ → pausa/reanuda countdown (manual)
      $('toggle').onclick = async ()=>{
        await fetch('/control/countdown/toggle', { method:'POST' });
        await poll();
      };

      // ⏮ → sin acción especial (puedes poner /control/unschedule si quieres)
      $('prev').onclick = null;

      return;
    }


    // ===== SESIÓN ACTIVA =====
    if(j.active){
      const phaseColor = j.phase_color || '#ffffff';
      t.className = 'timer phase';
      t.style.color = phaseColor;
      t.textContent = fmt(j.phase_remaining_s ?? 0);
      info.textContent = (j.phase_key || 'Fase') + (j.paused ? ' · PAUSA' : '');
      info.style.color = phaseColor;
      controls.style.display = '';
      hint.innerHTML = '';

      $('prev').onclick   = async ()=>{ await fetch('/control/prev',        {method:'POST'}); await poll(); };
      $('next').onclick   = async ()=>{ await fetch('/control/next',        {method:'POST'}); await poll(); };
      $('toggle').onclick = async ()=>{ await fetch('/control/toggle_pause',{method:'POST'}); await poll(); };
      return;
    }

    // ===== INACTIVA =====
    t.className = 'timer';
    t.style.color = '';
    t.textContent = '--:--';
    info.textContent = 'Sin sesión';
    info.style.color = 'var(--muted)';
    controls.style.display = 'none';
    hint.innerHTML = '';

    $('prev').onclick = $('next').onclick = $('toggle').onclick = null;
  }catch(e){
    // silencioso
  }
}


/* ==================== CONTROLES ==================== */
$('prev').onclick   = async ()=>{ await fetch('/control/prev',        {method:'POST'}); await poll(); };
$('next').onclick   = async ()=>{ await fetch('/control/next',        {method:'POST'}); await poll(); };
$('toggle').onclick = async ()=>{ await fetch('/control/toggle_pause',{method:'POST'}); await poll(); };

/* ==================== INIT ==================== */
setInterval(poll, 1000);
loadClasses();
poll();

document.addEventListener('visibilitychange', () => {
  if (!document.hidden) loadClasses();
});
</script>
</body>
</html>
