<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Usuarios HRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/brand.css">
  <style>
    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .filters button{ margin:0 2px; }
    .sim-ctrl{ display:flex; align-items:center; gap:8px; }
    .sim-ctrl input[type="number"]{ width:96px; }
    .muted{ opacity:.8; font-size:.9em; }
    .status-msg{ min-height: 1.2em; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; background:#1f2937; color:#fff; font-size:.8em; }
    .badge .dot{ width:8px; height:8px; border-radius:50%; background:#10b981; display:inline-block; }
    .badge-inline{ margin-left:6px; }
    .badge-auto{ background:#334155; }
    .badge-manual{ background:#7c3aed; }
    .btn[disabled]{ opacity:.6; pointer-events:none; }
    .table-wrap{ overflow:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üë§ Usuarios HRM</h1>

    <!-- Barra de herramientas -->
    <div class="toolbar">
      <a class="btn btn-accent" href="{{ url_for('users.add') }}">‚ûï A√±adir usuario</a>

      <div class="filters" role="group" aria-label="Filtro">
        <button type="button" class="active" data-filter="all" id="btn-all">Todos (0)</button>
        <button type="button" data-filter="real" id="btn-real">Reales (0)</button>
        <button type="button" data-filter="sim" id="btn-sim">Simulados (0)</button>
      </div>

      <!-- Control de simulados -->
      <div class="sim-ctrl" style="margin-left:auto">
        <label for="simCount"><strong>Simulados:</strong></label>
        <input id="simCount" type="number" min="0" step="1" value="{{ sim_count or 0 }}" />
        <button id="applySim" class="btn">Aplicar</button>
        <span id="simStatus" class="muted status-msg"></span>
      </div>
    </div>

    <!-- Tabla -->
    <div class="panel card-pad table-wrap">
      <table id="tab">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre / Apodo</th>
            <th>Edad</th>
            <th>Peso</th>
            <th>Sexo</th>
            <th>ID</th>
            <th>FCR</th>
            <th>FCM√°x</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          {% set edad_disp = (u.dob|age_from_dob) or u.edad %}
          {% set hrmax_disp = u.hr_max if u.hr_max else ((u.dob|tanaka_dob) or (u.edad|tanaka)) %}
          <tr class="{{ 'sim' if u.is_sim else '' }}" data-is-sim="{{ 1 if u.is_sim else 0 }}">
            <td>{{ u.id }}</td>
            <td>
              {{ u.nombre }} {{ u.apellido }}
              {% if u.apodo %}
                <span class="muted">¬∑ {{ u.apodo }}</span>
              {% endif %}
              {% if u.is_sim %}
                <span class="badge" title="Usuario simulado">
                  <span class="dot"></span> Simulado
                </span>
              {% endif %}
            </td>
            <td class="{{ 'muted' if not edad_disp }}">{{ edad_disp or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.peso }}">{{ u.peso or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.sexo }}">{{ u.sexo or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.device_id }}">{{ u.device_id or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.hr_rest }}">{{ u.hr_rest or '‚Äî' }}</td>

            <!-- FC M√°x + badge Auto/Manual -->
            <td class="{{ 'muted' if not hrmax_disp }}">
              {{ hrmax_disp or '‚Äî' }}
              {% if hrmax_disp %}
                {% if u.hr_max_auto == 1 %}
                  <span class="badge badge-pill badge-inline badge-auto"
                        title="Calculada autom√°ticamente (Tanaka)">Auto</span>
                {% else %}
                  <span class="badge badge-pill badge-inline badge-manual"
                        title="Valor manual (no se ajusta con la edad)">Manual</span>
                {% endif %}
              {% endif %}
            </td>

            <td>
              <a class="btn btn-ghost" href="{{ url_for('users.edit', user_id=u.id) }}">‚úèÔ∏è Editar</a>
              <a class="btn btn-danger"
                 href="{{ url_for('users.delete', user_id=u.id) }}"
                 onclick="return confirm('¬øBorrar usuario &quot;{{ u.apodo or u.nombre }}&quot;?')">
                 üóëÔ∏è Borrar
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (function(){
      const rows = Array.from(document.querySelectorAll('tbody tr'));
      const btns = Array.from(document.querySelectorAll('.filters button'));
      const btnAll  = document.getElementById('btn-all');
      const btnReal = document.getElementById('btn-real');
      const btnSim  = document.getElementById('btn-sim');

      function counts(){
        const total = rows.length;
        const sim = rows.filter(r => r.dataset.isSim === "1").length;
        const real = total - sim;
        return { total, real, sim };
      }

      function paintCounts(){
        const { total, real, sim } = counts();
        btnAll.textContent  = `Todos (${total})`;
        btnReal.textContent = `Reales (${real})`;
        btnSim.textContent  = `Simulados (${sim})`;
      }

      function setFilter(mode){
        rows.forEach(tr => {
          const isSim = tr.dataset.isSim === "1";
          let show = true;
          if (mode === 'real') show = !isSim;
          else if (mode === 'sim') show = isSim;
          tr.style.display = show ? '' : 'none';
        });
        btns.forEach(b => b.classList.toggle('active', b.dataset.filter === mode));
      }

      btns.forEach(b => b.addEventListener('click', () => setFilter(b.dataset.filter)));

      // Inicializar
      paintCounts();
      setFilter('all');
    })();

    // ===== Control de simulados =====
    (function(){
      const input  = document.getElementById('simCount');
      const apply  = document.getElementById('applySim');
      const status = document.getElementById('simStatus');

      let debTimer = null;

      async function postCount(n){
        try{
          apply.disabled = true;
          status.textContent = 'Aplicando‚Ä¶';
          const res = await fetch('/users/simulated', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ count: n })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.ok){
            throw new Error(data.error || 'Error aplicando cambios');
          }
          status.textContent = 'Hecho ‚úì';
          // Recarga para refrescar tabla y contadores
          setTimeout(() => { window.location.reload(); }, 300);
        }catch(e){
          status.textContent = 'Error: ' + (e.message || e);
          apply.disabled = false;
        }
      }

      // Click expl√≠cito
      apply.addEventListener('click', () => {
        const n = Math.max(0, parseInt(input.value || '0', 10));
        postCount(n);
      });

      // Tambi√©n con debounce al escribir
      input.addEventListener('input', () => {
        if (debTimer) clearTimeout(debTimer);
        debTimer = setTimeout(() => {
          const n = Math.max(0, parseInt(input.value || '0', 10));
          postCount(n);
        }, 600);
      });
    })();
  </script>
</body>
</html>
