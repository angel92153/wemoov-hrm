<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Usuarios HRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/brand.css">
  <style>
    .inline-controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .muted{opacity:.7}
    .saved-badge{font-size:.9em;color:var(--accent,#22c55e);opacity:0;transition:opacity .2s ease}
    .saved-badge.show{opacity:1}
    .filters button.active{background:var(--accent,#22c55e);color:#fff}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:.15rem .45rem;border-radius:999px;background:#2a2f43;color:#cbd5e1;font-size:.75rem}
    .badge .dot{width:.55em;height:.55em;border-radius:50%;background:#8b5cf6}
    .badge-auto{background:#1f2937}
    .badge-manual{background:#3b1f1f}
    .badge-inline{margin-left:.35rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üë§ Usuarios HRM</h1>

    <!-- Barra de herramientas -->
    <div class="toolbar" style="gap:18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
      <div class="inline-controls">
        <a class="btn btn-accent" href="{{ url_for('users.add') }}">‚ûï A√±adir usuario</a>

        <!-- Control "Simulados: N" (auto-guardar) -->
        <label class="muted" for="simCount">Simulados:</label>
        <input id="simCount" type="number" min="0" step="1" value="{{ sim_count or 0 }}" style="width:90px">
        <span id="saved" class="saved-badge">‚úì Guardado</span>
      </div>

      <div class="filters" role="group" aria-label="Filtro">
        <button type="button" class="active" data-filter="all" id="btn-all">Todos (0)</button>
        <button type="button" data-filter="real" id="btn-real">Reales (0)</button>
        <button type="button" data-filter="sim" id="btn-sim">Simulados (0)</button>
      </div>
    </div>

    <!-- Tabla -->
    <div class="panel card-pad table-wrap">
      <table id="tab">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre / Apodo</th>
            <th>Edad</th>
            <th>Peso</th>
            <th>Sexo</th>
            <th>ID</th>
            <th>FCR</th>
            <th>FCM√°x</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          {% set edad_disp = (u.dob|age_from_dob) or u.edad %}
          {% set hrmax_disp = u.hr_max if u.hr_max else ((u.dob|tanaka_dob) or (u.edad|tanaka)) %}
          <tr class="{{ 'sim' if u.is_sim else '' }}" data-is-sim="{{ 1 if u.is_sim else 0 }}">
            <td>{{ u.id }}</td>
            <td>
              {{ u.nombre }} {{ u.apellido }}
              {% if u.apodo %}
                <span class="muted">¬∑ {{ u.apodo }}</span>
              {% endif %}
              {% if u.is_sim %}
                <span class="badge" title="Usuario simulado">
                  <span class="dot"></span> Simulado
                </span>
              {% endif %}
            </td>
            <td class="{{ 'muted' if not edad_disp }}">{{ edad_disp or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.peso }}">{{ u.peso or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.sexo }}">{{ u.sexo or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.device_id }}">{{ u.device_id or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.hr_rest }}">{{ u.hr_rest or '‚Äî' }}</td>

            <!-- FC M√°x + badge Auto/Manual -->
            <td class="{{ 'muted' if not hrmax_disp }}">
              {{ hrmax_disp or '‚Äî' }}
              {% if hrmax_disp %}
                {% if u.hr_max_auto == 1 %}
                  <span class="badge badge-pill badge-inline badge-auto"
                        title="Calculada autom√°ticamente (Tanaka)">Auto</span>
                {% else %}
                  <span class="badge badge-pill badge-inline badge-manual"
                        title="Valor manual (no se ajusta con la edad)">Manual</span>
                {% endif %}
              {% endif %}
            </td>

            <td>
              <a class="btn btn-ghost" href="{{ url_for('users.edit', user_id=u.id) }}">‚úèÔ∏è Editar</a>
              <a class="btn btn-danger"
                 href="{{ url_for('users.delete', user_id=u.id) }}"
                 onclick="return confirm('¬øBorrar usuario &quot;{{ u.apodo or u.nombre }}&quot;?')">
                 üóëÔ∏è Borrar
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (function(){
      // ------- filtros + contadores ------
      const rows = Array.from(document.querySelectorAll('tbody tr'));
      const btns = Array.from(document.querySelectorAll('.filters button'));
      const btnAll  = document.getElementById('btn-all');
      const btnReal = document.getElementById('btn-real');
      const btnSim  = document.getElementById('btn-sim');

      function counts(){
        const total = rows.length;
        const sim = rows.filter(r => r.dataset.isSim === "1").length;
        const real = total - sim;
        return { total, real, sim };
      }
      function paintCounts(){
        const { total, real, sim } = counts();
        btnAll.textContent  = `Todos (${total})`;
        btnReal.textContent = `Reales (${real})`;
        btnSim.textContent  = `Simulados (${sim})`;
      }
      function setFilter(mode){
        rows.forEach(tr => {
          const isSim = tr.dataset.isSim === "1";
          let show = true;
          if (mode === 'real') show = !isSim;
          else if (mode === 'sim') show = isSim;
          tr.style.display = show ? '' : 'none';
        });
        btns.forEach(b => b.classList.toggle('active', b.dataset.filter === mode));
      }
      btns.forEach(b => b.addEventListener('click', () => setFilter(b.dataset.filter)));
      paintCounts(); setFilter('all');

      // ------- simulados: auto-guardar sin bot√≥n ------
      const inp = document.getElementById('simCount');
      const saved = document.getElementById('saved');
      let timer = null;

      function showSaved(){
        saved.classList.add('show');
        setTimeout(() => saved.classList.remove('show'), 1000);
      }

      async function applySimCount(n){
        try{
          const res = await fetch('/users/simulated', {
            method:'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({count: Number(n)})
          });
          const data = await res.json();
          if (!res.ok || !data.ok) throw new Error(data.error || 'error');
          showSaved();
          // recargamos para reflejar altas/bajas
          location.reload();
        }catch(e){
          alert('No se pudo ajustar el n√∫mero de simulados.');
        }
      }

      inp.addEventListener('input', () => {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => applySimCount(inp.value || 0), 300);
      });
    })();
  </script>
</body>
</html>
