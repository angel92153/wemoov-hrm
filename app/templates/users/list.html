<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Usuarios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/brand.css">
  <style>
    .inline-controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .muted{opacity:.7}
    .saved-badge{font-size:.9em;color:var(--accent,#22c55e);opacity:0;transition:opacity .2s ease}
    .saved-badge.show{opacity:1}
    .filters button.active{background:var(--accent,#22c55e);color:#fff}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:.15rem .45rem;border-radius:999px;background:#2a2f43;color:#cbd5e1;font-size:.75rem}
    .badge .dot{width:.55em;height:.55em;border-radius:50%;background:#8b5cf6}
    .badge-auto{background:#1f2937}
    .badge-manual{background:#3b1f1f}
    .badge-inline{margin-left:.35rem}

    /* Buscador */
    .toolbar .field{display:grid;gap:6px;min-width:220px}
    .toolbar label{font-size:.85rem;color:var(--muted,#a5adbb)}
    .toolbar input[type="search"]{
      padding:.55rem .7rem;border:1px solid var(--border,#2a2a2a);
      border-radius:10px;background:#0f0f10;color:#fff;outline:none;min-width:240px
    }
    .no-rows{padding:1rem;text-align:center;color:#a5adbb}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üë§ Usuarios</h1>

    <!-- Barra de herramientas -->
    <div class="toolbar" style="gap:18px;display:flex;justify-content:space-between;align-items:flex-end;flex-wrap:wrap">
      <div class="inline-controls" style="row-gap:14px">
        <a class="btn btn-accent" href="{{ url_for('users.add') }}">‚ûï A√±adir usuario</a>

        <!-- Control "Simulados: N" (auto-guardar) -->
        <label class="muted" for="simCount">Simulados:</label>
        <input id="simCount" type="number" min="0" step="1" value="{{ sim_count or 0 }}" style="width:90px">
        <span id="saved" class="saved-badge">‚úì Guardado</span>
      </div>

      <div class="inline-controls" style="gap:12px">
        <!-- SOLO: buscador -->
        <div class="field">
          <label for="userSearch">Buscar</label>
          <input id="userSearch" type="search" placeholder="Nombre, apellido, apodo o device id‚Ä¶"
                 aria-label="Buscar por nombre, apellido, apodo o device id">
        </div>

        <div class="filters" role="group" aria-label="Filtro">
          <button type="button" class="active" data-filter="all" id="btn-all">Todos (0)</button>
          <button type="button" data-filter="real" id="btn-real">Reales (0)</button>
          <button type="button" data-filter="sim" id="btn-sim">Simulados (0)</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="panel card-pad table-wrap">
      <table id="tab">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre / Apodo</th>
            <th>Edad</th>
            <th>Peso</th>
            <th>Sexo</th>
            <th>ID</th>
            <th>FCR</th>
            <th>FCM√°x</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody">
          {% for u in users %}
          {% set edad_disp = (u.dob|age_from_dob) or u.edad %}
          {% set hrmax_disp = u.hr_max if u.hr_max else ((u.dob|tanaka_dob) or (u.edad|tanaka)) %}
          <tr class="{{ 'sim' if u.is_sim else '' }}" data-is-sim="{{ 1 if u.is_sim else 0 }}">
            <td>{{ u.id }}</td>
            <td>
              <span class="name">{{ u.nombre }}</span> <span class="lastname">{{ u.apellido }}</span>
              {% if u.apodo %}
                <span class="muted apodo">¬∑ {{ u.apodo }}</span>
              {% endif %}
              {% if u.is_sim %}
                <span class="badge" title="Usuario simulado">
                  <span class="dot"></span> Simulado
                </span>
              {% endif %}
            </td>
            <td class="{{ 'muted' if not edad_disp }}">{{ edad_disp or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.peso }}">{{ u.peso or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.sexo }}">{{ u.sexo or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.device_id }}">{{ u.device_id or '‚Äî' }}</td>
            <td class="{{ 'muted' if not u.hr_rest }}">{{ u.hr_rest or '‚Äî' }}</td>

            <!-- FC M√°x + badge Auto/Manual -->
            <td class="{{ 'muted' if not hrmax_disp }}">
              {{ hrmax_disp or '‚Äî' }}
              {% if hrmax_disp %}
                {% if u.hr_max_auto == 1 %}
                  <span class="badge badge-pill badge-inline badge-auto"
                        title="Calculada autom√°ticamente (Tanaka)">Auto</span>
                {% else %}
                  <span class="badge badge-pill badge-inline badge-manual"
                        title="Valor manual (no se ajusta con la edad)">Manual</span>
                {% endif %}
              {% endif %}
            </td>

            <td>
              <a class="btn btn-ghost" href="{{ url_for('users.edit', user_id=u.id) }}">‚úèÔ∏è Editar</a>
              <a class="btn btn-danger"
                 href="{{ url_for('users.delete', user_id=u.id) }}"
                 onclick="return confirm('¬øBorrar usuario &quot;{{ u.apodo or u.nombre }}&quot;?')">
                 üóëÔ∏è Borrar
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div id="emptyMsg" class="no-rows" style="display:none">No hay resultados con los filtros actuales.</div>
    </div>
  </div>

  <script>
    (function(){
      // ------- utilidades -------
      const normalize = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
      const debounce = (fn,ms=200)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

      // ------- DOM -------
      const rows = Array.from(document.querySelectorAll('#tbody tr'));
      const btns = Array.from(document.querySelectorAll('.filters button'));
      const btnAll  = document.getElementById('btn-all');
      const btnReal = document.getElementById('btn-real');
      const btnSim  = document.getElementById('btn-sim');
      const userSearch = document.getElementById('userSearch');
      const emptyMsg = document.getElementById('emptyMsg');

      const inp = document.getElementById('simCount');
      const saved = document.getElementById('saved');

      // ------- estado -------
      let mode = 'all';
      let query = '';

      function baseCounts(){
        const total = rows.length;
        const sim = rows.filter(r => r.dataset.isSim === "1").length;
        const real = total - sim;
        return { total, real, sim };
      }

      function paintCountsVisible(){
        const visibles = rows.filter(tr => tr.style.display !== 'none');
        const simV = visibles.filter(tr => tr.dataset.isSim === "1").length;
        const totalV = visibles.length;
        const realV = totalV - simV;
        btnAll.textContent  = `Todos (${totalV})`;
        btnReal.textContent = `Reales (${realV})`;
        btnSim.textContent  = `Simulados (${simV})`;
      }

      function applyFilters(){
        const q = normalize(query);
        let visible = 0;

        rows.forEach(tr => {
          const isSim = tr.dataset.isSim === "1";
          const inMode = (mode==='all') || (mode==='real' && !isSim) || (mode==='sim' && isSim);

          const nameCell = tr.cells[1];
          const name = normalize(nameCell.querySelector('.name')?.textContent);
          const last = normalize(nameCell.querySelector('.lastname')?.textContent);
          const apodoEl = nameCell.querySelector('.apodo');
          const apodo = normalize(apodoEl ? apodoEl.textContent.replace('¬∑','') : '');

          const deviceIdCell = tr.cells[5]; // columna "ID" (device_id)
          const deviceId = normalize(deviceIdCell?.textContent);

          const matches = !q ||
            name.includes(q) ||
            last.includes(q) ||
            `${name} ${last}`.includes(q) ||
            apodo.includes(q) ||
            deviceId.includes(q);

          const show = inMode && matches;
          tr.style.display = show ? '' : 'none';
          if (show) visible++;
        });

        emptyMsg.style.display = visible === 0 ? '' : 'none';
        paintCountsVisible();
      }

      function setFilter(next){
        mode = next;
        btns.forEach(b => b.classList.toggle('active', b.dataset.filter === mode));
        applyFilters();
      }

      // Contadores iniciales (totales sin filtrar)
      (function initCounts(){
        const { total, real, sim } = baseCounts();
        btnAll.textContent  = `Todos (${total})`;
        btnReal.textContent = `Reales (${real})`;
        btnSim.textContent  = `Simulados (${sim})`;
      })();

      btns.forEach(b => b.addEventListener('click', () => setFilter(b.dataset.filter)));
      setFilter('all');

      // Buscador
      userSearch.addEventListener('input', debounce(e => {
        query = e.target.value || '';
        applyFilters();
      }, 200));

      // ------- simulados: auto-guardar (igual que antes) -------
      let timer = null;
      function showSaved(){ saved.classList.add('show'); setTimeout(()=>saved.classList.remove('show'), 1000); }
      async function applySimCount(n){
        try{
          const res = await fetch('/users/simulated', {
            method:'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({count: Number(n)})
          });
          const data = await res.json();
          if (!res.ok || !data.ok) throw new Error(data.error || 'error');
          showSaved();
          location.reload();
        }catch(e){
          alert('No se pudo ajustar el n√∫mero de simulados.');
        }
      }
      inp.addEventListener('input', () => {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => applySimCount(inp.value || 0), 300);
      });
    })();
  </script>
</body>
</html>
