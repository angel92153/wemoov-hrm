<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{{ 'Editar usuario' if user else 'Añadir usuario' }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/static/brand.css">
  <style>
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
    }
    .grid > div{ grid-column: span 6; }
    .grid > .full{ grid-column: 1 / -1; }

    .actions{
      grid-column: 1 / -1;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-start;
      margin-top:8px;
    }
    .actions .btn{ padding:12px 16px; font-weight:800; }

    form label{ display:block; font-weight:700; margin:0 0 6px; }
    form input, form select{
      width:100%;
      padding:12px 14px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#0f0f0f;
      color:var(--text);
      font-size:16px;
      line-height:1.2;
      outline:none;
    }
    form input:focus, form select:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(139,92,246,.25);
    }
    .switch { display:flex; align-items:center; gap:10px; margin-top:6px; }
    .switch input[type="checkbox"]{ width:22px; height:22px; cursor:pointer; }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"]{ -moz-appearance: textfield; appearance: textfield; }

    .panel.card-pad{ padding:16px; }
    .wrap{ max-width: 900px; margin: 0 auto; }

    @media (max-width: 980px){
      .grid{ gap:12px; }
      .grid > div{ grid-column: span 12; }
      .actions{ justify-content:stretch; }
      .actions .btn{ flex:1 1 auto; text-align:center; }
    }

    @media (max-width: 600px){
      .panel.card-pad{ padding:12px; }
      .actions{ gap:10px; }
      .actions .btn{ padding:12px; }
      form input, form select{ padding:12px; }
    }
  </style>
</head>
<body
  data-self-uid="{{ user.id if user else '' }}"
  data-self-device="{{ user.device_id if user and user.device_id else '' }}">

  <div class="wrap">
    <h1>{{ 'Editar usuario' if user else 'Añadir usuario' }}</h1>

    <div class="panel card-pad">
      <form method="post" action="" class="grid">

        <div>
          <label>Nombre</label>
          <input name="nombre" value="{{ user.nombre if user else '' }}" required>
        </div>

        <div>
          <label>Apellido</label>
          <input name="apellido" value="{{ user.apellido if user else '' }}" required>
        </div>

        <div>
          <label>Apodo</label>
          <input name="apodo" value="{{ user.apodo if user else '' }}" required>
        </div>

        <div>
          <label>Email <span class="muted-small">(opcional)</span></label>
          <input type="email" name="email" autocomplete="email"
                 value="{{ user.email if user and user.email else '' }}">
        </div>

        <div>
          <label>Sexo</label>
          {% set s = (user.sexo if user else 'M') or 'M' %}
          <select name="sexo" required>
            <option value="M" {{ 'selected' if s == 'M' else '' }}>M</option>
            <option value="F" {{ 'selected' if s == 'F' else '' }}>F</option>
          </select>
        </div>

        <div>
          <label>Fecha de nacimiento</label>
          <input type="date" name="dob" value="{{ user.dob if user and user.dob else '' }}" required>
          {% if user and user.dob %}
            <div class="form-help">Edad detectada: {{ user.dob|age_from_dob or '—' }}</div>
          {% endif %}
        </div>

        <div>
          <label>Peso (kg)</label>
          <input type="number" step="0.1" name="peso" min="1" max="500"
                 value="{{ user.peso if user and user.peso else '' }}" required>
        </div>

        <div>
          <label>FC Reposo</label>
          <input type="number" name="hr_rest" min="30" max="120"
                 value="{{ user.hr_rest if user and user.hr_rest else '' }}">
        </div>

        {% set auto = (user.hr_max_auto == 1) if user else true %}
        {% set hrmax_disp = (user.hr_max if user and user.hr_max else ((user.dob|tanaka_dob) or (user.edad|tanaka))) %}
        <div>
          <label>FC Máx</label>
          <div class="switch">
            <input type="checkbox" id="hrmax_auto" name="hr_max_auto" {{ 'checked' if auto else '' }}>
            <label for="hrmax_auto" class="muted">Calcular automáticamente</label>
          </div>
          <input type="number" id="hr_max" name="hr_max" min="120" max="230"
                 value="{{ '' if auto else (hrmax_disp or '') }}"
                 placeholder="{{ auto and (hrmax_disp or '') }}"
                 {{ 'disabled' if auto else '' }}>
        </div>

        <!-- Device ID limpio -->
        <div class="full">
          <label>Device ID</label>
          <input id="device_id"
                 type="text"
                 inputmode="numeric"
                 pattern="\d*"
                 name="device_id"
                 list="freeDevices"
                 value="{{ user.device_id if user and user.device_id else '' }}">
          <datalist id="freeDevices"></datalist>
        </div>

        <!-- DEMO Device (se llena desde /api/demo_devices) -->
        <div class="full">
          <label>DEMO Device</label>
          <select id="demo_device" name="demo_device">
            <option value="">— Cargando DEMO Devices… —</option>
          </select>
        </div>


        <div class="actions">
          <button type="submit" class="btn btn-accent">{{ 'Guardar cambios' if user else 'Crear usuario' }}</button>
          <a href="{{ url_for('users.index') }}" class="btn">Volver</a>
        </div>

      </form>
    </div>
  </div>

  <script>
    const rawSelf = document.body.getAttribute('data-self-uid');
    const rawDev  = document.body.getAttribute('data-self-device');
    const SELF_UID = rawSelf ? Number(rawSelf) : null;
    const SELF_DEVICE = rawDev ? Number(rawDev) : null;

    const chkAuto = document.getElementById('hrmax_auto');
    const inpHrMx = document.getElementById('hr_max');
    chkAuto.addEventListener('change', () => {
      const on = chkAuto.checked;
      inpHrMx.disabled = on;
      if (on) inpHrMx.value = '';
    });

    const inputDev  = document.getElementById('device_id');
    const dataList  = document.getElementById('freeDevices');

    const RECENT_S   = 45;
    const POLL_MS    = 5000;
    const TIMEOUT_MS = 6000;
    let pollTimer = null;

    async function loadFree() {
      const ctl = new AbortController();
      const t = setTimeout(() => ctl.abort(), TIMEOUT_MS);
      try {
        const url = new URL('/api/unassigned_devices', window.location.origin);
        url.searchParams.set('recent', RECENT_S);
        if (SELF_UID !== null) url.searchParams.set('allow_user_id', SELF_UID);

        const res = await fetch(url.toString(), { cache: 'no-store', signal: ctl.signal });
        const data = await res.json();
        const list = (data && Array.isArray(data.devices)) ? data.devices : [];

        dataList.innerHTML = '';
        list.forEach(d => {
          const devId = Number(d.dev);
          const opt = document.createElement('option');
          opt.value = String(devId);
          dataList.appendChild(opt);
        });
      } catch {
        dataList.innerHTML = '';
      } finally {
        clearTimeout(t);
      }
    }

    function schedule(){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(() => { if (!document.hidden) loadFree(); }, POLL_MS);
    }

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) loadFree();
    });

    loadFree();
    schedule();

    inputDev.addEventListener('input', () => {
      const v = inputDev.value.trim();
      if (v && !/^\d+$/.test(v)) inputDev.value = v.replace(/\D+/g, '');
    });

    // === DEMO Devices -> poblar el <select> desde /api/demo_devices ===
    const selDemo = document.getElementById('demo_device');

    async function loadDemoDevicesSelect(){
      try{
        const r = await fetch('/api/demo_devices', { cache: 'no-store' });
        const data = await r.json().catch(()=> ({}));
        const list = Array.isArray(data.devices) ? data.devices : [];

        selDemo.innerHTML = '';

        if (!list.length){
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '— No hay DEMO Devices —';
          selDemo.appendChild(opt);
          return;
        }

        // Opción placeholder
        const opt0 = document.createElement('option');
        opt0.value = '';
        opt0.textContent = '';
        selDemo.appendChild(opt0);

        // Opciones: mostramos "ID · DeviceID", value = device_id (num)
        // Si prefieres que el value sea el ID de la fila: usa String(it.id)
        list.forEach(it => {
          const opt = document.createElement('option');
          opt.value = String(it.device_id);                   // <-- value
          opt.textContent = `#${it.id} · ${it.device_id}`;    // <-- label
          opt.dataset.demoId = String(it.id);                 // por si luego lo necesitas
          selDemo.appendChild(opt);
        });

        // Si quieres preseleccionar algo, aquí podrías leer un valor previo
        // ej. si el servidor te pasa {{ selected_demo_device or '' }}
        // const current = '{{ selected_demo_device or "" }}';
        // if (current) selDemo.value = String(current);

      }catch(e){
        selDemo.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '(Error cargando DEMO Devices)';
        selDemo.appendChild(opt);
      }
    }

    // Llamada inicial al cargar la página del formulario
    loadDemoDevicesSelect();
  </script>
</body>
</html>
